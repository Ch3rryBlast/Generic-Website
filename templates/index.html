<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">  
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Parts Marketplace</title>
<style>
.tableWrap {
  overflow-x: auto;
}

#leaderboardTable {
  width: 100%;
  border-collapse: collapse;
  font-family: ui-sans-serif, system-ui;
  background: white;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0,0,0,0.06);
}

#leaderboardTable thead {
  background: linear-gradient(90deg,#4ade80,#22c55e);
  color: white;
  text-align: left;
}

#leaderboardTable th,
#leaderboardTable td {
  padding: 14px 16px;
}

#leaderboardTable tbody tr {
  border-bottom: 1px solid #f1f1f1;
  transition: background 0.2s ease;
}

#leaderboardTable tbody tr:hover {
  background: #f7fff9;
}

#leaderboardTable tbody tr:nth-child(1) td:first-child {
  font-weight: bold;
  color: #f59e0b;
}

#leaderboardTable tbody tr:nth-child(2) td:first-child {
  font-weight: bold;
  color: #9ca3af;
}

#leaderboardTable tbody tr:nth-child(3) td:first-child {
  font-weight: bold;
  color: #d97706;
}

.card {
  background: white;
  padding: 22px;
  border-radius: 18px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.08);
}
</style>
<body>
{% include "sidebar.html" %}

<div class="wrap">

  <!-- HERO -->
  <div class="hero">
    <h1>EcoMatch Progress </h1>
    <p>
      Recycle items to earn points (XP)! Level up to become an eco champion and climb the leaderboard.
    </p>
  </div>

  <!-- LEADERBOARD -->
  <div class="card" style="margin-top:22px; max-width:600px; margin-left:auto; margin-right:auto;">
    <h2>Leaderboard</h2>

    <div class="tableWrap">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Level</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Floating Level/XP Widget -->
<div id="xpWidget" style="
  position:fixed;
  bottom:24px;
  right:24px;
  background: linear-gradient(135deg,#4ade80,#1b7a43);
  color:white;
  border-radius:18px;
  padding:14px 18px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.12);
  font-family:ui-sans-serif,system-ui;
  min-width:200px;
  z-index:999;
">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
    <div style="font-weight:900; font-size:18px;">Level <span id="userLevel">1</span></div>
    <div style="text-align:right; font-size:12px; opacity:.9;">XP: <span id="totalXP">0</span></div>
  </div>
  <div id="levelTitle" style="font-size:13px; font-weight:700; opacity:.85; margin-bottom:6px;">Recycler Rookie</div>
  <div style="background:rgba(255,255,255,.25); height:10px; border-radius:999px; overflow:hidden;">
    <div id="xpBar" style="height:100%; width:0%; background:white; border-radius:999px; transition:width .4s ease;"></div>
  </div>
  <div style="margin-top:4px; font-size:11px; opacity:.85;" id="currentXP">0 / <span id="xpNeeded">100</span> XP to next level</div>
</div>

<script>
// ---------------- LEVEL SYSTEM ----------------
function getUsers(){
  return JSON.parse(localStorage.getItem("usersPoints")) || [];
}

function calculateLevel(totalXP){
  let level = 1;
  let xpNeeded = 100;
  let remainingXP = totalXP;

  while(remainingXP >= xpNeeded){
    remainingXP -= xpNeeded;
    level++;
    xpNeeded = 100 + (level - 1) * 150;
  }

  return { level, currentXP: remainingXP, xpNeeded };
}

function getLevelTitle(level){
  if(level <= 5) return "Recycler Rookie";
  if(level <= 10) return "Eco Warrior";
  if(level <= 20) return "Planet Protector";
  if(level <= 35) return "Sustainability Champion";
  return "Environmental Legend";
}

// ---------------- RENDER LEVEL WIDGET ----------------
async function renderLevelWidget(){
  const res = await fetch("/api/entries");
  const data = await res.json();
  const entries = data.entries || [];
  const totalXP = entries.reduce((sum, e) => sum + Number(e.points || 0), 0);

  const levelData = calculateLevel(totalXP);

document.getElementById("userLevel").textContent = levelData.level;
document.getElementById("totalXP").textContent = totalXP;

// ✅ Add this line — it was missing!
document.getElementById("levelTitle").textContent = getLevelTitle(levelData.level);

document.getElementById("currentXP").textContent =
    levelData.currentXP + " / " + levelData.xpNeeded + " XP to next level";
document.getElementById("xpBar").style.width =
    (levelData.currentXP / levelData.xpNeeded * 100) + "%";
}

// ---------------- LEADERBOARD ----------------
async function renderLeaderboard(){
  const res = await fetch("/api/leaderboard");
  const data = await res.json();

  const users = data.leaderboard;
  const currentUserId = data.current_user;

  const tbody = document.querySelector("#leaderboardTable tbody");
  tbody.innerHTML = "";

  users.forEach((user, index)=>{
    const levelData = calculateLevel(user.total_points || 0);

    const tr = document.createElement("tr");

    if(user.id === currentUserId){
      tr.style.background = "#eafff1";
      tr.style.fontWeight = "bold";
    }

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${user.name}</td>
      <td>${levelData.level}</td>
      <td>${user.total_points}</td>
    `;

    tbody.appendChild(tr);
  });
}

// ---------------- INIT ----------------
document.addEventListener("DOMContentLoaded", async () => {
  await renderLeaderboard();
  await renderLevelWidget();
});

// Optional: update XP widget live whenever recycling points change
window.addEventListener("storage", () => {
  renderLevelWidget();
  renderLeaderboard();
});
</script>