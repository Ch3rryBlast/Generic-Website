<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="styles.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recycling Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#eaf5ef;
    --panel:#ffffff;
    --text:#0f172a;
    --muted:#475569;
    --green:#1b7a43;
    --green2:#4ade80;
    --mint:#bff2d1;
    --border:rgba(15,23,42,.12);
    --shadow: 0 14px 40px rgba(0,0,0,.10);
    --radius:20px;
  }

  body{
    margin:0;
    display:flex;
    min-height:100vh;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: radial-gradient(1200px 500px at 10% 0%, rgba(74,222,128,.35), transparent 60%),
                radial-gradient(1200px 500px at 85% 10%, rgba(34,197,94,.25), transparent 60%),
                var(--bg);
    color:var(--text);
  }

  .wrap{
    flex:1;
    padding: 26px 26px 40px;
  }

  .hero{
    background: linear-gradient(135deg, rgba(27,122,67,.96), rgba(74,222,128,.78));
    color:white;
    padding:22px 22px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
  }
  .hero:after{
    content:"";
    position:absolute;
    inset:-80px -80px auto auto;
    width:260px;
    height:260px;
    background: radial-gradient(circle, rgba(255,255,255,.25), transparent 60%);
    border-radius:999px;
  }

  .hero h1{
    margin:0;
    font-size:34px;
    letter-spacing:.5px;
  }
  .hero p{
    margin:8px 0 0;
    opacity:.95;
    max-width: 820px;
    line-height:1.35;
  }

  .stats{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:16px;
  }
  .stat{
    background: rgba(255,255,255,.18);
    border: 1px solid rgba(255,255,255,.25);
    border-radius: 999px;
    padding:10px 14px;
    font-weight:900;
    display:flex;
    gap:10px;
    align-items:center;
    backdrop-filter: blur(8px);
  }
  .stat span{
    background: rgba(255,255,255,.22);
    padding:4px 10px;
    border-radius: 999px;
  }

  .grid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:18px;
    margin-top:18px;
    align-items:start;
  }
  @media (max-width: 1000px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 10px 28px rgba(0,0,0,.08);
    padding: 18px;
  }

  .card h2{
    margin:0 0 12px;
    font-size:18px;
    color: #0b3d22;
    letter-spacing:.2px;
  }

  label{
    font-size:12px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.6px;
    color: var(--muted);
    display:block;
    margin:12px 0 8px;
  }

  input, button{
    width:100%;
    padding: 12px 12px;
    border-radius: 14px;
    border:1px solid var(--border);
    font-size:14px;
    outline:none;
    box-sizing:border-box;
  }
  input:focus{
    border-color: rgba(27,122,67,.35);
    box-shadow: 0 0 0 5px rgba(74,222,128,.22);
  }

  .row{
    display:flex;
    gap:10px;
  }
  .row > *{ flex:1; }

  .btn{
    border:none;
    cursor:pointer;
    font-weight:1000;
    letter-spacing:.3px;
    background: linear-gradient(135deg, var(--green2), var(--green));
    color:white;
    transition:.2s;
  }
  .btn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
  .btn:active{ transform: translateY(0px); }

  /* Autocomplete dropdown */
  .acWrap{ position:relative; }
  .acBox{
    position:absolute;
    left:0; right:0;
    top: 52px;
    background:white;
    border:1px solid var(--border);
    border-radius: 14px;
    box-shadow: 0 18px 38px rgba(0,0,0,.12);
    overflow:hidden;
    z-index:20;
    display:none;
    max-height: 280px;
    overflow:auto;
  }
  .acItem{
    padding:12px;
    cursor:pointer;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .acItem:hover{ background:#f3fff7; }
  .acItem strong{ display:block; }
  .acItem small{ color: var(--muted); }

  .result{
    margin-top:14px;
    background: linear-gradient(135deg, rgba(191,242,209,.55), rgba(255,255,255,.9));
    border:1px solid rgba(27,122,67,.15);
    border-radius: 18px;
    padding:14px;
  }
  .badge{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    font-weight:1000;
    background:#0b3d22;
    color:white;
    margin-bottom:8px;
  }
  .result p{ margin:8px 0 0; color: var(--muted); }
  .result ul{ margin:10px 0 0 18px; color: var(--muted); }

  .filters{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:8px 0 10px;
  }
  .chip{
    border:1px solid var(--border);
    background:#fff;
    padding:8px 10px;
    border-radius:999px;
    font-weight:1000;
    cursor:pointer;
    color: var(--muted);
  }
  .chip.active{
    background:#eafff1;
    color:#0b3d22;
    border-color: rgba(27,122,67,.25);
  }

  table{
    width:100%;
    border-collapse:collapse;
    min-width:720px;
    font-size:13px;
  }
  th, td{
    padding:12px;
    border-bottom:1px solid rgba(0,0,0,.08);
    text-align:left;
    white-space:nowrap;
  }
  th{
    background:#f6fff9;
    color:#0b3d22;
    font-weight:1000;
    text-transform:uppercase;
    letter-spacing:.45px;
    font-size:12px;
  }
  .tableWrap{
    overflow:auto;
    border:1px solid rgba(0,0,0,.08);
    border-radius: 16px;
  }
</style>
</head>
<script src="darkmode.js"></script>
<body>
  {% include "sidebar.html" %}
   <div class="topbar">
    <button id="signInBtn">Sign In</button>
  </div>

  <div class="wrap">
    <div class="hero">
      <h1>Recycling Tracker</h1>
      <p>Type anything (not a limited list). We’ll tell you whether it belongs in recycling, compost, landfill, or special drop-off — plus prep instructions and notes.</p>
      <div class="stats">
        <div class="stat">Total Items <span id="totalItems">0</span></div>
        <div class="stat">Total Points <span id="totalPoints">0</span></div>
        <div class="stat">Today <span id="todayItems">0</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>Log an Item</h2>

        <form id="logForm">
          <label>Search Item</label>
          <div class="acWrap">
            <input id="itemInput" name="item" placeholder="e.g. battery, plastic bottle, laptop, pizza box..." autocomplete="off" required />
            <div class="acBox" id="acBox"></div>
          </div>

          <div class="row">
            <div>
              <label>Amount</label>
              <input id="amount" name="amount" type="number" min="1" step="1" value="1" required />
            </div>
            <div>
              <label>Unit</label>
              <input id="unit" value="count" />
            </div>
          </div>

          <button class="btn" type="submit">Log Recycling</button>
        </form>

        <div class="result" id="lookupCard">
          <div class="badge" id="binBadge">Recycle</div>
          <div style="font-weight:1000; font-size:16px;" id="lookupTitle"></div>
          <p id="lookupNotes"></p>
          <div id="prepBlock"></div>
          <p style="margin-top:10px;">
            <a id="lookupLink" href="#" target="_blank" style="font-weight:1000; color:#0b3d22;">Open local drop-off search →</a>
          </p>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>Progress</h2>
        <div class="filters" id="filters"></div>
        <div style="height:280px;">
          <canvas id="chart"></canvas>
        </div>

        <h2 style="margin-top:18px;">History (All Entries)</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Item</th>
                <th>Amount</th>
                <th>Bin</th>
                <th>Material</th>
                <th>Points</th>
                <th>Prep</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const itemInput = document.getElementById("itemInput");
const acBox = document.getElementById("acBox");
const logForm = document.getElementById("logForm");

const lookupCard = document.getElementById("lookupCard");
const binBadge = document.getElementById("binBadge");
const lookupTitle = document.getElementById("lookupTitle");
const lookupNotes = document.getElementById("lookupNotes");
const prepBlock = document.getElementById("prepBlock");
const lookupLink = document.getElementById("lookupLink");

const tbody = document.getElementById("tbody");
const filters = document.getElementById("filters");

const totalItems = document.getElementById("totalItems");
const totalPoints = document.getElementById("totalPoints");
const todayItems = document.getElementById("todayItems");

let entries = [];
let currentFilter = "All";
let chart;

function todayISO(){ return new Date().toISOString().slice(0,10); }
function fmt(n){ const x=Number(n||0); return Number.isFinite(x)? x.toFixed(2).replace(/\.00$/,"") : "0"; }

async function api(url, opts){ const r = await fetch(url, opts); return r.json(); }

function showLookup(info, q){
  lookupCard.style.display = "block";
  const bin = info.bin || "Depends";
  binBadge.textContent = bin;
  binBadge.style.background =
    bin === "Recycle" ? "#0b3d22" :
    bin === "Compost" ? "#166534" :
    bin === "Landfill" ? "#334155" :
    bin === "Special Drop-off" ? "#7c2d12" : "#0f172a";

  lookupTitle.textContent = info.name || q;
  lookupNotes.textContent = info.notes || "";

  const prep = info.prep || [];
  if (prep.length){
    prepBlock.innerHTML = "<ul>" + prep.map(x => `<li>${x}</li>`).join("") + "</ul>";
  } else {
    prepBlock.innerHTML = "";
  }

  lookupLink.href = info.link || "https://search.earth911.com/";
}

const GOOGLE_API_KEY = "AIzaSyC5uWjeGJPKX4RtwSX0FBmOuiXUoQP386w";
const GOOGLE_CSE_ID = "01287394edc92482a";

async function lookupNow(q){
  if (!q.trim()) return;

  try {
    const searchQuery = `how to dispose ${q} recycling site:.gov OR site:.edu OR site:earth911.com`;

    const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CSE_ID}&q=${encodeURIComponent(searchQuery)}&num=3`;

    const res = await fetch(url);
    const data = await res.json();

    if (!data.items || !data.items.length) {
      lookupCard.style.display = "none";
      return;
    }

    const top = data.items[0];
    const snippet = top.snippet || "";
    const link = top.link || "";

    const text = snippet.toLowerCase();

    let bin = "Depends";
    let material = "Unknown";

    if (text.includes("drop off") || text.includes("hazardous") || text.includes("e-waste")) {
      bin = "Special Drop-off";
      material = "Hazardous";
    } 
    else if (text.includes("compost")) {
      bin = "Compost";
      material = "Organic";
    }
    else if (text.includes("recycle")) {
      bin = "Recycle";
      material = "Mixed";
    }
    else if (text.includes("trash") || text.includes("landfill")) {
      bin = "Landfill";
      material = "Waste";
    }

    showLookup({
      name: q,
      bin: bin,
      notes: snippet,
      prep: ["Follow local municipal guidelines"],
      link: link,
      material: material
    }, q);

  } catch (err) {
    console.error(err);
  }
}

document.addEventListener("click", (e) => {
  if (!acBox.contains(e.target) && e.target !== itemInput) acBox.style.display="none";
});

function buildFilters(materials){
  filters.innerHTML = "";
  ["All", ...materials].forEach(m => {
    const b = document.createElement("button");
    b.className = "chip" + (m === currentFilter ? " active" : "");
    b.textContent = m;
    b.onclick = () => { currentFilter = m; buildFilters(materials); renderAll(); };
    filters.appendChild(b);
  });
}

function renderTable(){
  const filtered = entries.filter(e => currentFilter === "All" || (e.material || "Unknown") === currentFilter);

  tbody.innerHTML = filtered.slice().reverse().map(e => `
    <tr>
      <td>${e.date || ""}</td>
      <td>${e.item || ""}</td>
      <td>${fmt(e.amount)}</td>
      <td>${e.bin || ""}</td>
      <td>${e.material || "Unknown"}</td>
      <td>${fmt(e.points)}</td>
      <td title="${e.prep || ""}">${(e.prep || "").slice(0,40)}${(e.prep||"").length>40?"…":""}</td>
    </tr>
  `).join("");
}

function renderStats(){
  totalItems.textContent = entries.length;
  totalPoints.textContent = fmt(entries.reduce((s,e)=>s+Number(e.points||0),0));
  todayItems.textContent = entries.filter(e => e.date === todayISO()).length;
}

function renderChart(){
  const filtered = entries.filter(e => currentFilter === "All" || (e.material || "Unknown") === currentFilter);

  const byDate = {};
  filtered.forEach(e => {
    const d = e.date || "";
    byDate[d] = (byDate[d] || 0) + Number(e.points || 0);
  });
  const labels = Object.keys(byDate).sort();
  const values = labels.map(d => byDate[d]);

  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Points per day", data: values, borderRadius: 12, barThickness: 18 }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

function renderAll(){
  renderStats();
  renderTable();
  renderChart();
}

async function loadEntries(){
  const out = await api("/api/entries");
  entries = out.entries || [];
  const materials = [...new Set(entries.map(e => e.material || "Unknown"))].sort();
  if (!materials.includes(currentFilter)) currentFilter = "All";
  buildFilters(materials);
  renderAll();
}

logForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(logForm);

  const res = await fetch("/recycling/item", { method:"POST", body: fd });
  const data = await res.json();

  if (data.error){ alert(data.error); return; }

  // Show info card immediately using backend-returned info (if present)
  if (data.item_info) showLookup(data.item_info, itemInput.value);

  // auto reload everything (no refresh button)
  await loadEntries();

  // keep the item text, reset amount only
  document.getElementById("amount").value = 1;
});

loadEntries();
</script>
</body>
</html>